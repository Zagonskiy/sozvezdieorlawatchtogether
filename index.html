<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Созвездие Орла | Watch Together</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f1014;
            --panel-color: #1a1c24;
            --accent-color: #7289da;
            --text-color: #e0e0e0;
            --secondary-text: #949ba4;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Анимация звездного фона */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.1;
            z-index: -1;
        }

        /* Меню входа */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            z-index: 10;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 40px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(114, 137, 218, 0.5);
        }

        .input-group {
            margin-bottom: 20px;
            text-align: center;
        }

        input[type="text"] {
            background: var(--panel-color);
            border: 1px solid #333;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            width: 250px;
            text-align: center;
            outline: none;
            transition: 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px rgba(114, 137, 218, 0.3);
        }

        .btn-container {
            display: flex;
            gap: 15px;
        }

        button {
            background: var(--accent-color);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            background: #5b6eae;
        }

        button.secondary {
            background: var(--panel-color);
            border: 1px solid #333;
        }

        button.secondary:hover {
            background: #252833;
        }

        /* Интерфейс комнаты */
        #room-screen {
            display: none; /* Скрыт по умолчанию */
            flex-direction: row;
            height: 100%;
        }

        .video-container {
            flex: 3;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        video {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
        }

        .controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            gap: 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .video-container:hover .controls-overlay {
            opacity: 1;
        }

        .sidebar {
            flex: 1;
            max-width: 350px;
            background: var(--panel-color);
            border-left: 1px solid #2a2d36;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2a2d36;
            background: rgba(0,0,0,0.2);
        }

        .room-info {
            font-size: 12px;
            color: var(--secondary-text);
            margin-top: 5px;
            user-select: all;
            cursor: pointer;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            word-wrap: break-word;
        }

        .message .author {
            font-weight: bold;
            color: var(--accent-color);
            font-size: 12px;
            margin-bottom: 2px;
            display: block;
        }

        .message.system {
            background: transparent;
            color: var(--secondary-text);
            text-align: center;
            font-style: italic;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #2a2d36;
            display: flex;
            gap: 10px;
        }

        #file-input {
            display: none;
        }

        .upload-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Скроллбар */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="stars"></div>

    <div id="login-screen">
        <h1><i class="fas fa-eagle"></i> Созвездие Орла</h1>
        
        <div class="input-group">
            <input type="text" id="nickname" placeholder="Твой никнейм" maxlength="15">
        </div>

        <div class="btn-container">
            <button onclick="createRoom()"><i class="fas fa-plus"></i> Создать комнату</button>
            <button class="secondary" onclick="showJoinInput()"><i class="fas fa-sign-in-alt"></i> Присоединиться</button>
        </div>
        
        <div id="join-input-container" style="display:none; margin-top: 15px;">
            <input type="text" id="room-id-input" placeholder="ID Комнаты" style="width: 200px; margin-bottom: 10px;">
            <br>
            <button onclick="joinRoom()" style="width: 100%;">Войти</button>
        </div>
    </div>

    <div id="room-screen">
        <div class="video-container">
            <label for="file-input" class="upload-btn" id="upload-label" style="display:none;">
                <i class="fas fa-upload"></i> Выбрать видео
            </label>
            <input type="file" id="file-input" accept="video/*">

            <video id="main-video" controls disablePictureInPicture controlsList="nodownload"></video>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <div id="room-status">Ожидание...</div>
                <div class="room-info" id="room-id-display" onclick="copyRoomId()" title="Нажми, чтобы скопировать">
                    ID: ...
                </div>
            </div>
            
            <div id="chat-messages">
                </div>

            <div class="chat-input-area">
                <input type="text" id="chat-msg" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" style="padding: 10px 15px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        let peer;
        let conn;
        let myStream;
        let currentUser = '';
        let isHost = false;
        let connections = [];
        
        const videoElement = document.getElementById('main-video');
        const fileInput = document.getElementById('file-input');
        
        // --- ГЕНЕРАТОР СЛУЧАЙНОГО ID ---
        // Это решает проблему с CORS, так как мы не просим сервер придумать нам ID
        function generateId() {
            return 'eagle-' + Math.random().toString(36).substr(2, 9);
        }

        // --- ЛОГИКА ИНТЕРФЕЙСА ---

        function showJoinInput() {
            document.getElementById('join-input-container').style.display = 'block';
        }

        function switchScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('room-screen').style.display = 'flex';
        }

        function log(msg, type = 'system') {
            const chat = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            if (type === 'user') {
                div.innerHTML = `<span class="author">${msg.author}</span>${msg.text}`;
            } else {
                div.innerText = msg;
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function copyRoomId() {
            const text = document.getElementById('room-id-display').innerText.replace('ID: ', '');
            navigator.clipboard.writeText(text);
            alert('ID скопирован!');
        }

        // --- ЛОГИКА PeerJS (СЕТЬ) ---

        function initPeer(customId = null) {
            currentUser = document.getElementById('nickname').value || 'Аноним';
            
            // Если ID не передан (мы создаем комнату), генерируем его сами
            // Если мы присоединяемся, ID нам не нужен (он создастся автоматом, но лучше задать)
            const myId = customId || generateId();

            // ВАЖНО: Мы задаем ID вручную первым параметром, чтобы пропустить шаг fetch('/id'),
            // который вызывает ошибку CORS.
            peer = new Peer(myId, {
                debug: 2,
                secure: true, // Обязательно для https (GitHub Pages)
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                }
            });

            peer.on('open', (id) => {
                console.log('My ID is: ' + id);
                document.getElementById('room-id-display').innerText = 'ID: ' + id;
                
                // Если мы создаем комнату - переключаем экран сразу
                // Если присоединяемся - экран переключится, когда установится соединение
                if (isHost) {
                    switchScreen();
                    log(`Комната создана. Ждем участников...`);
                    document.getElementById('upload-label').style.display = 'block';
                }
            });

            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'peer-unavailable') {
                    alert('Комната с таким ID не найдена или создатель вышел.');
                } else if (err.type === 'unavailable-id') {
                    alert('Ошибка ID. Попробуйте обновить страницу.');
                } else {
                    alert('Ошибка соединения: ' + err.type);
                }
            });

            // Входящие соединения (чат)
            peer.on('connection', (c) => {
                // Хост принимает всех
                if (isHost) {
                    connections.push(c);
                    setupConnection(c);
                    // Если стрим уже идет, сразу звоним новому участнику
                    if (myStream) {
                        setTimeout(() => {
                            try {
                                peer.call(c.peer, myStream);
                                console.log('Calling new peer with stream');
                            } catch(e) { console.error(e); }
                        }, 1000);
                    }
                } else {
                    // Гость принимает соединение от хоста
                    setupConnection(c);
                }
            });

            // Входящие звонки (видео)
            peer.on('call', (call) => {
                console.log('Receiving call...');
                call.answer(null); // Отвечаем
                call.on('stream', (remoteStream) => {
                    console.log('Stream received');
                    videoElement.srcObject = remoteStream;
                    videoElement.play().catch(e => {
                        console.log('Autoplay blocked', e);
                        // Показываем кнопку "Play" если автоплей заблокирован
                        alert('Нажми на видео, чтобы запустить звук/картинку (политика браузера)');
                    });
                    
                    if (!isHost) {
                        videoElement.controls = false; 
                        log("Трансляция началась.");
                    }
                });
            });
        }

        function setupConnection(c) {
            conn = c;
            
            c.on('open', () => {
                console.log('Connection opened');
                // Если мы гость и соединение открылось - переходим в комнату
                if (!isHost) {
                    switchScreen();
                    c.send({ type: 'system', text: `${currentUser} вошел в чат!` });
                }
            });

            c.on('data', (data) => {
                if (data.type === 'chat') {
                    log({ author: data.author, text: data.text }, 'user');
                    if (isHost) broadcastData(data, c.peer); 
                } else if (data.type === 'system') {
                    log(data.text);
                }
            });
            
            c.on('close', () => {
                log('Связь потеряна');
                connections = connections.filter(con => con.peer !== c.peer);
            });
        }

        // --- ФУНКЦИИ ХОСТА ---

        function createRoom() {
            isHost = true;
            initPeer(); // ID сгенерируется внутри
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    videoElement.src = url;
                    
                    videoElement.onloadedmetadata = () => {
                        try {
                            // captureStream работает в Chrome/Firefox
                            // В Safari может потребоваться play() перед захватом
                            const stream = videoElement.captureStream ? videoElement.captureStream() : videoElement.mozCaptureStream();
                            myStream = stream;
                            
                            // Звоним всем, кто уже подключен
                            connections.forEach(conn => {
                                console.log('Calling ' + conn.peer);
                                peer.call(conn.peer, stream);
                            });
                            
                            log("Видео загружено. Старт трансляции...");
                        } catch (err) {
                            alert("Ваш браузер не поддерживает захват видео из файла. Пожалуйста, используйте Chrome или Firefox (Desktop).");
                            console.error(err);
                        }
                    };
                }
            });
        }

        // --- ФУНКЦИИ ГОСТЯ ---

        function joinRoom() {
            const destId = document.getElementById('room-id-input').value.trim();
            if (!destId) return alert("Введите ID");
            
            isHost = false;
            // Генерируем свой ID сами, чтобы избежать CORS
            initPeer();
            
            // Ждем пока наш Peer откроется, потом коннектимся
            peer.on('open', () => {
                console.log('Connecting to ' + destId);
                conn = peer.connect(destId);
                
                conn.on('error', (err) => {
                    console.error('Connection error:', err);
                    alert('Не удалось подключиться к хосту. Проверьте ID.');
                });

                setupConnection(conn);
            });
        }

        // --- ОБЩИЕ ФУНКЦИИ ---

        function sendMessage() {
            const input = document.getElementById('chat-msg');
            const text = input.value;
            if (!text) return;

            const msgData = { type: 'chat', author: currentUser, text: text };
            log({ author: currentUser, text: text }, 'user');
            
            if (isHost) {
                broadcastData(msgData);
            } else if (conn && conn.open) {
                conn.send(msgData);
            }
            input.value = '';
        }

        function broadcastData(data, excludePeerId = null) {
            if (!isHost) return;
            connections.forEach(c => {
                if (c.peer !== excludePeerId && c.open) {
                    c.send(data);
                }
            });
        }
    </script>
</body>
</html>
